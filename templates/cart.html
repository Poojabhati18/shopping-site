{% extends "base.html" %}

{% block title %}Your Cart - Ayurvedic Store{% endblock %}

{% block content %}
  <div class="header-right">
    {% if customer %}
      <a href="{{ url_for('auth.logout_customer') }}" style="text-decoration:none; color:#fff;">
        <img src="{{ url_for('static', filename='profile_icon.png') }}" 
             alt="Profile" 
             style="width:25px; vertical-align:middle; border-radius:50%;">
        {{ customer.name }}
      </a>
    {% else %}
      <a href="{{ url_for('auth.login_customer') }}">Login</a> |
      <a href="{{ url_for('auth.signup') }}">Sign Up</a>
    {% endif %}
  </div>

  <h2>Your Shopping Cart üõí</h2>

  {% if cart %}
    <table class="cart-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Price (‚Çπ)</th>
          <th>Quantity</th>
          <th>Total (‚Çπ)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart %}
        <tr data-id="{{ item.id }}">
          <td>{{ item.name }}</td>
          <td>{{ item.price }}</td>
          <td>
            <input type="number" class="qty" min="1" value="{{ item.quantity }}">
          </td>
          <td class="line-total">{{ item.price * item.quantity }}</td>
          <td>
            <button class="remove-btn">‚ùå Remove</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3 class="cart-total">Grand Total: ‚Çπ<span id="grandTotal">
      {{ cart | sum(attribute='price', start=0) }}
    </span></h3>

    <form action="{{ url_for('checkout') }}" method="POST">
      <button type="submit" class="checkout-btn">Proceed to Checkout ‚úÖ</button>
    </form>
  {% else %}
    <p>Your cart is empty. <a href="{{ url_for('products') }}">Browse Products</a></p>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  const cartContainer = document.getElementById("cartContainer");
  const cartTotal = document.getElementById("cartTotal");
  const checkoutBtn = document.querySelector(".checkout-button");
  let cart = JSON.parse(localStorage.getItem("cart")) || [];

  function renderCart() {
    cartContainer.innerHTML = "";
    let total = 0;

    if (cart.length === 0) {
      cartContainer.innerHTML = "<p>Your cart is empty.</p>";
      cartTotal.textContent = "Total: ‚Çπ0";
      updateCheckoutButton();
      return;
    }

    cart.forEach((item, index) => {
      const price = Number(item.price) || 0;
      const quantity = Number(item.qty) || 1;
      const itemTotal = price * quantity;
      total += itemTotal;

      const itemElement = document.createElement("div");
      itemElement.className = "cart-item";
      itemElement.innerHTML = `
        <img src="${item.image}" alt="${item.name}">
        <div class="item-info">
          <div class="item-name">${item.name}</div>
          <div class="item-price">‚Çπ${price} x ${quantity} = ‚Çπ${itemTotal}</div>
          <div class="quantity-controls">
            <button onclick="changeQuantity(${index}, -1)">‚Äì</button>
            ${quantity}
            <button onclick="changeQuantity(${index}, 1)">+</button>
          </div>
          <button class="remove-button" onclick="removeItem(${index})">Remove</button>
        </div>
      `;
      cartContainer.appendChild(itemElement);
    });

    cartTotal.textContent = `Total: ‚Çπ${total}`;
    updateCheckoutButton();
  }

  function updateCheckoutButton() {
    if (cart.length === 0) {
      checkoutBtn.disabled = true;
      checkoutBtn.style.opacity = "0.5";
      checkoutBtn.style.cursor = "not-allowed";
    } else {
      checkoutBtn.disabled = false;
      checkoutBtn.style.opacity = "1";
      checkoutBtn.style.cursor = "pointer";
    }
  }

  function changeQuantity(index, delta) {
    const item = cart[index];
    item.qty = Number(item.qty) || 1;
    item.qty += delta;
    if (item.qty < 1) item.qty = 1;
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }

  function prepareCheckout() {
    const orderDetails = cart.map(item => {
      return `${item.name} (‚Çπ${item.price} x ${item.qty}) = ‚Çπ${item.price * item.qty}`;
    }).join('\n');

    const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

    localStorage.setItem("orderDetails", orderDetails);
    localStorage.setItem("orderTotal", totalPrice);

    location.href = '{{ url_for("checkout_page") }}';
  }

  renderCart();
</script>
{% endblock %}
