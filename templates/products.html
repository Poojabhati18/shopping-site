<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Products - Ayurvedic Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<meta name="theme-color" content="#4CAF50">
<style>
  :root{
  --green-1:#3d5a40;
  --green-2:#5a7f65;
  --green-3:#2b4d3a;
  --bg:#f9f6f1;
  --leaf:#b0e57c;
  --text:#2e2e2e;
}

body {
  font-family: "Poppins", sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 0;
  color: var(--text);
}

/* Navbar */
nav {
  display: flex;
  align-items: center;
  justify-content: space-between; /* spread left and right items */
  flex-wrap: wrap;
  gap: 12px;
  max-width: 1100px;
  margin: 0 auto;
  padding: 10px 20px;
}

nav > button {
  background: linear-gradient(135deg, #5a7f65, #2b4d3a);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}
nav > button:hover {
  background: #3d5a40;
}

/* Controls (search + filters) */
.controls {
  display: flex;
  gap: 10px;
  max-width: 1000px; /* wider search area */
  margin: 20px auto;
  padding: 0 20px;
  flex-wrap: wrap;
  align-items: center;
}

#searchBox {
  flex: 1;           /* takes most space */
  min-width: 400px;  /* ensures long search box */
  padding: 10px 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

#categoryBox, #priceBox {
  flex: 0 0 150px;  /* smaller than search box */
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
}

/* Profile / Auth Buttons on right */
.header-right {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-left: auto; /* push to far right */
}

.auth-buttons button {
  background: linear-gradient(135deg, var(--green-2), var(--green-3));
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s ease;
}
.auth-buttons button:hover {
  background: var(--green-1);
}

/* Profile dropdown */
.profile-dropdown {
  position: relative;
  display: inline-block;
}
.profile-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  background: linear-gradient(135deg, var(--green-2), var(--green-3));
  color: #fff;
  padding: 6px 12px;
  border-radius: 25px;
  cursor: pointer;
  transition: background 0.2s ease;
}
.profile-toggle:hover {
  background: var(--green-1);
}
.profile-icon {
  width: 25px;
  height: 25px;
  border-radius: 50%;
}
.customer-name {
  font-weight: 600;
}
.dropdown-menu {
  display: none;
  position: absolute;
  top: 110%;
  right: 0;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  min-width: 140px;
  z-index: 1000;
  text-align: left;
  padding: 8px 0;
}
.dropdown-menu a,
.dropdown-menu button {
  display: block;
  width: 100%;
  padding: 10px 14px;
  color: var(--text);
  text-decoration: none;
  font-size: 0.9rem;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  transition: background 0.2s ease, color 0.2s ease;
}
.dropdown-menu a:hover,
.dropdown-menu button:hover {
  background: #f1f1f1;
  color: var(--green-3);
}
.profile-dropdown:hover .dropdown-menu {
  display: block;
}

/* Container & Product cards */
.container, #productList {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  max-width: 1100px;
  margin: 0 auto 80px;
  padding: 20px;
}

.product-card {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  overflow: hidden;
  transition: transform 0.2s ease;
  position: relative;
  display: flex;
  flex-direction: column;
}
.product-card:hover {
  transform: translateY(-8px) scale(1.03);
  box-shadow: 0 12px 24px rgba(61, 90, 64, 0.25);
  border: 2px solid var(--leaf);
  z-index: 10;
}
.product-card img {
 width: 100%;
 aspect-ratio: 1 / 1;
 object-fit: cover;
 border-radius: 10px 10px 0 0;
}
.product-card h2, .product-card p, .product-card .price, .product-card .btn {
 margin: 8px 15px;
 text-align: center;
}
.product-card p {
  margin: 5px 20px;
  color: #555;
}
.price {
  font-weight: bold;
  color: var(--green-3);
  margin: 10px 20px;
}

/* Buttons inside product cards */
.btn, .add-to-cart, .toggle-reviews-btn {
  background: linear-gradient(135deg, var(--green-2), var(--green-3));
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s ease;
  margin: 5px 10px;
}
.btn:hover, .add-to-cart:hover, .toggle-reviews-btn:hover { 
  background: var(--green-1); 
}

/* Quantity selector */
.qty-selector {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin: 10px 0;
}
.qty-selector button {
  width: 30px; height: 30px;
  border-radius: 50%;
  font-weight: bold;
  border:none;
  background:#eee;
  cursor:pointer;
}
.qty-selector button:disabled{
  opacity:.5;
  cursor:not-allowed;
}

/* Cart animation */
#cartCount.bump {
  animation: bump 300ms ease;
}
@keyframes bump{
  0%{ transform: scale(1); }
  50%{ transform: scale(1.25); }
  100%{ transform: scale(1); }
}

/* Reviews */
.reviews {
  margin: 10px 20px;
  padding: 10px 0 0;
  border-top: 1px solid #e6e6e6;
}
.review-item {
  margin-bottom: 10px;
}
.review-stars {
  display: inline-block;
  font-size: 1.1rem;
  color: #f7d000;
  margin-right: 8px;
}
.average-rating{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:10px;
  font-weight:600;
  color:#394d39;
}
.average-rating .avg-stars{
  font-size:1.1rem;
  letter-spacing:2px;
}
.average-rating small{ color:#666; font-weight:400; }

/* Policy links */
.policy-links {
  position: fixed;
  bottom: 10px;
  right: 20px;
  display: flex;
  flex-direction: row;
  gap: 15px;
  z-index: 999;
}
.policy-links a {
  color: var(--green-1);
  font-size: 0.85rem;
  text-decoration: none;
  transition: color 0.2s;
}
.policy-links a:hover {
  color: var(--leaf);
  text-decoration: underline;
}

/* Review form */
.review-form {
  background-color: #f4f7ed;
  padding: 15px;
  border-radius: 12px;
  margin-top: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.review-form textarea {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #cdd3c5;
  background-color: #f0f6ed;
  resize: none;
  margin-bottom: 6px;
  font-family: inherit;
}
.review-form .char-counter{
  text-align:right;
  font-size:.85rem;
  color:#666;
  margin-bottom:10px;
}
.review-form button[type="submit"] {
  background-color: var(--green-2);
  color: #fffdf6;
  border: none;
  border-radius: 12px;
  padding: 10px;
  width: 100%;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.3s;
}
.review-form button[type="submit"]:hover { background-color: var(--green-1); }
.review-form button[type="submit"][disabled]{ opacity:.7; cursor:not-allowed; }

/* Star selector */
.star-selector {
  user-select:none;
  display:flex;
  gap:6px;
  margin-bottom:8px;
}
.star-selector span {
  font-size: 1.8rem;
  cursor: pointer;
  color: #cdd3c5;
  transition: transform 0.15s ease, color 0.2s ease;
  display:inline-block;
  line-height:1;
}
.star-selector span.selected, .star-selector span.hovered {
  background: linear-gradient(90deg, #f7d000, #ffae00);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  color: transparent;
  transform: translateY(-1px) scale(1.05);
}

/* Toast notifications */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 8px;
  background: #fff;
  border-radius: 12px;
  padding: 10px 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  font-weight: 500;
  z-index: 2000;
  animation: slideUp 0.25s ease, fadeOut 0.5s ease 2.6s forwards;
}
.toast.success { border-left: 5px solid var(--green-2); }
.toast.error { border-left: 5px solid #c0392b; }
.toast .icon { font-size:1.1rem; }

@keyframes slideUp {
  from { transform: translate(-50%, 20px); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}
@keyframes fadeOut { to { opacity: 0; transform: translate(-50%, 20px);} }

/* Filter buttons */
.filter-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 20px 0;
  flex-wrap: wrap;
}
.filter-buttons button {
  background: linear-gradient(135deg, var(--green-2), var(--green-3));
  color: #fff;
  border: none;
  padding: 12px 25px;
  border-radius: 30px;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.filter-buttons button:hover {
  background: linear-gradient(135deg, var(--green-3), var(--green-2));
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}
.filter-buttons button:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(176, 229, 124, 0.5);
}

/* Login / Signup / Profile already handled above with .header-right */

</style>
</head>
<body>
 <nav>
  <!-- Left buttons -->
  <div class="nav-left">
    <button onclick="location.href='{{ url_for('home') }}'">üè† Home</button>
    <button onclick="location.href='{{ url_for('products_page') }}'">üõçÔ∏è Products</button>
    <button onclick="location.href='{{ url_for('cart_page') }}'">üõí Cart <span id="cartCount" style="background:red;color:white;padding:2px 8px;border-radius:50%;font-size:12px;">0</span></button>
    <button onclick="location.href='{{ url_for('about_page') }}'">üë©‚Äç‚öïÔ∏è About Us</button>
    <button onclick="location.href='{{ url_for('contact_page') }}'">üìû Contact Us</button>
  </div>

  <!-- Right auth buttons -->
  <div class="header-right">
    {% if customer %}
      <div class="profile-dropdown">
        <div class="profile-toggle">
          <img src="{{ url_for('static', filename='profile_icon.png') }}" alt="Profile" class="profile-icon">
          <span class="customer-name">{{ customer.name }}</span>
        </div>
        <div class="dropdown-menu">
          <button onclick="location.href='{{ url_for('auth.logout_customer') }}'">Logout</button>
        </div>
      </div>
    {% else %}
      <div class="auth-buttons">
        <button onclick="location.href='{{ url_for('auth.login_customer') }}'">Login</button>
        <button onclick="location.href='{{ url_for('auth.signup') }}'">Sign Up</button>
      </div>
    {% endif %}
  </div>
</nav>

<div class="controls">
  <input type="text" id="searchBox" placeholder="Search products..." />

  <select id="categoryBox">
    <option value="all">All Categories</option>
    <option value="wellness">Wellness</option>
    <option value="medicinal">Medicinal</option>
    <option value="personalcare">Personal Care</option>
  </select>

  <select id="priceBox">
    <option value="default">Sort by Price</option>
    <option value="low">Low to High</option>
    <option value="high">High to Low</option>
  </select>
</div>

  <div class="policy-links">
    <a href="{{ url_for('refund_page') }}">Cancellation & Refunds</a>
    <a href="{{ url_for('privacy_page') }}">Privacy Policy</a>
    <a href="{{ url_for('terms_page') }}">Terms & Conditions</a>
    <a href="{{ url_for('shipping_page') }}">Shipping Policy</a>
  </div>

<div id="productList"></div>

<script>
let products = {{ products|tojson }};
let filteredProducts = [...products];

document.addEventListener("DOMContentLoaded", () => {

  /* ====== Utility Functions ====== */
  function debounce(fn, delay=300) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  function showToast(msg, type="success") {
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.style.cssText = `
      position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
      border-radius: 6px; color: #fff; font-weight: bold; z-index: 9999;
      background-color: ${type==="success"?"#28a745":"#dc3545"}; opacity:0; transition:opacity 0.3s;
    `;
    toast.innerHTML = (type==="success"?"‚úÖ ":"‚ö†Ô∏è ") + msg;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = 1; }, 50);
    setTimeout(() => { toast.style.opacity = 0; setTimeout(() => toast.remove(), 300); }, 3000);
  }

  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const total = cart.reduce((s, i) => s + i.qty, 0);
    const el = document.getElementById("cartCount");
    if (!el) return;
    el.textContent = total;
    el.classList.remove("bump"); void el.offsetWidth; el.classList.add("bump");
  }

  /* ====== Render Products ====== */
  function renderProducts() {
  const container = document.getElementById("productList");
  if (!container) return;

  container.innerHTML = ""; // clear old items

  filteredProducts.forEach(product => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.dataset.id = product.id;

    card.innerHTML = `
      <img src="${product.image_url}" alt="${product.name}">
      <h2>${product.name}</h2>
      <p class="price">‚Çπ${product.price}</p>
      <div class="qty-selector">
        <button class="minus">-</button>
        <span class="qty">1</span>
        <button class="plus">+</button>
      </div>
      <button class="add-to-cart">Add to Cart</button>
      <button class="show-description-btn btn">Description</button>
      <button class="toggle-reviews-btn">Show Reviews</button>
      <div class="reviews" style="display:none;">
        <div class="average-rating" data-product-id="${product.id}">
          <span class="avg-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
          <span class="avg-num">-</span>
          <small>(<span class="count">0</span> reviews)</small>
        </div>
        <div class="review-list">‚Äî</div>
        <form class="review-form" data-product-id="${product.id}">
          <div class="star-selector">
            <span data-value="1">‚òÜ</span>
            <span data-value="2">‚òÜ</span>
            <span data-value="3">‚òÜ</span>
            <span data-value="4">‚òÜ</span>
            <span data-value="5">‚òÜ</span>
          </div>
          <input type="hidden" name="rating" value="0">
          <textarea name="review" rows="3" maxlength="200" placeholder="Share your experience..."></textarea>
          <div class="char-counter">0/200</div>
          <button type="submit">Submit Review</button>
        </form>
      </div>
    `;

    container.appendChild(card);
    attachProductEvents(card, product);
    attachReviewEvents(card, product);
    ensureReviewsLoaded(card, product.id);
  });
}


  /* ====== Product Events ====== */
  function attachProductEvents(card, product) {
  const addBtn = card.querySelector(".add-to-cart");
  const plusBtn = card.querySelector(".plus");
  const minusBtn = card.querySelector(".minus");
  const qtyEl = card.querySelector(".qty");
  const descBtn = card.querySelector(".show-description-btn");
  const reviewBtn = card.querySelector(".toggle-reviews-btn");
  const reviewSection = card.querySelector(".reviews");

  let qty = 1;

  plusBtn?.addEventListener("click", () => { qty++; qtyEl.textContent = qty; });
  minusBtn?.addEventListener("click", () => { if(qty>1) qty--; qtyEl.textContent = qty; });

  addBtn?.addEventListener("click", () => {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const existingIndex = cart.findIndex(i => i.id === product.id);
    if(existingIndex > -1) cart[existingIndex].qty += qty;
    else cart.push({ id: product.id, name: product.name, price: product.price, image: product.image_url, qty });
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartCount();
    showToast(`${product.name} added to cart!`, "success");
    qty = 1; qtyEl.textContent = qty;
  });

  // ‚úÖ Description Button
  descBtn?.addEventListener("click", () => showDescriptionModal(product));

  // ‚úÖ Review toggle
  reviewBtn?.addEventListener("click", () => {
    if(reviewSection.style.display === "none"){
        reviewSection.style.display = "block";
        reviewBtn.textContent = "Hide Reviews";
    } else {
        reviewSection.style.display = "none";
        reviewBtn.textContent = "Show Reviews";
    }
  });
}

  /* ====== Reviews Fetch + Render Logic ====== */
const reviewCache = new Map();

async function fetchReviews(productId){
  const res = await fetch(`/api/reviews/${productId}`);
  return await res.json();
}

function renderReviews(list, container, avgContainer){
  if(!list.length){ container.innerHTML="<i>No reviews yet</i>"; return; }
  container.innerHTML="";
  let total=0;
  list.forEach(r=>{
    total+=Number(r.rating)||0;
    const el=document.createElement("div");
    el.className="review-item";
    el.innerHTML = `
      <span class="review-stars">${"‚≠êÔ∏è".repeat(r.rating)}</span>
      <div>${r.review}</div>
      <small>${new Date(r.timestamp).toLocaleString()}</small>
    `;
    container.appendChild(el);
  });
  const avg = total/list.length;
  avgContainer.querySelector(".avg-stars").textContent = "‚òÖ".repeat(Math.floor(avg)).padEnd(5,"‚òÜ");
  avgContainer.querySelector(".avg-num").textContent = avg.toFixed(1);
  avgContainer.querySelector(".count").textContent = String(list.length);
}

function attachReviewEvents(card, product){
  const form = card.querySelector(".review-form");
  const stars = card.querySelectorAll(".star-selector span");
  const hiddenRating = form.querySelector("input[name='rating']");
  const textarea = form.querySelector("textarea[name='review']");
  const counter = form.querySelector(".char-counter");
  const submitBtn = form.querySelector("button[type='submit']");

  stars.forEach(s=>{
    s.addEventListener("click",()=>{
      hiddenRating.value=s.dataset.value;
      stars.forEach(st=>st.classList.toggle("selected",st.dataset.value<=s.dataset.value));
    });
  });

  textarea.addEventListener("input",()=>counter.textContent=`${textarea.value.length}/200`);

  form.addEventListener("submit", async e=>{
    e.preventDefault();
    const rating = Number(hiddenRating.value);
    const reviewText = textarea.value.trim();
    if(rating===0||reviewText.length<10){ showToast("Rating & min 10 chars","error"); return; }
    submitBtn.disabled=true;
    try{
      const res = await fetch(`/api/reviews/${product.id}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({rating, review:reviewText})
      });
      const data = await res.json();
      if(data.success){
        showToast("Review submitted!","success");
        form.reset();
        hiddenRating.value=0;
        counter.textContent="0/200";
        stars.forEach(st=>st.classList.remove("selected"));
        reviewCache.delete(product.id);
        await ensureReviewsLoaded(card, product.id);
      } else {
        showToast(data.message,"error");
      }
    } catch(e){ console.error(e); showToast("Submit failed","error"); }
    finally{ submitBtn.disabled=false; }
  });
}

async function ensureReviewsLoaded(card, productId){
  const container = card.querySelector(".review-list");
  const avgContainer = card.querySelector(".average-rating");
  if(!reviewCache.has(productId)){
    const reviews = await fetchReviews(productId);
    reviewCache.set(productId,reviews);
  }
  renderReviews(reviewCache.get(productId), container, avgContainer);
}

  /* ====== Description Modal ====== */
  function showDescriptionModal(product) {
    const modal = document.createElement("div");
    modal.style.cssText = `
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;
      z-index: 9999; padding: 20px;
    `;

    modal.innerHTML = `
      <div style="background:#fff;padding:20px;border-radius:12px;max-width:500px;width:100%;position:relative;">
        <h2>${product.name}</h2>
        <p>${product.description || "No description available."}</p>
        <p class="price">‚Çπ${product.price}</p>
        <button id="closeModal" class="btn" style="position:absolute;top:10px;right:10px;">X</button>
      </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector("#closeModal").addEventListener("click", ()=>modal.remove());
    modal.addEventListener("click", e => { if(e.target===modal) modal.remove(); });
  }

  /* ====== Filters: Search + Category + Price ====== */
const searchBox = document.getElementById("searchBox");
const categoryBox = document.getElementById("categoryBox");
const priceBox = document.getElementById("priceBox");

function applyFilters() {
  let tempProducts = [...products];

  // ====== Category filter ======
  const categoryVal = categoryBox?.value || "all";
  if (categoryVal !== "all") {
    tempProducts = tempProducts.filter(p =>
      Array.isArray(p.categories)
        ? p.categories.includes(categoryVal)   // ‚úÖ supports multiple categories
        : p.category === categoryVal           // ‚úÖ fallback if product has single category
    );
  }

  // ====== Search filter ======
  const searchTerm = searchBox?.value.trim().toLowerCase() || "";
  if (searchTerm !== "") {
    tempProducts = tempProducts.filter(p =>
      p.name.toLowerCase().includes(searchTerm) ||
      (p.description && p.description.toLowerCase().includes(searchTerm))
    );
  }

  // ====== Price filter ======
  const priceVal = priceBox?.value || "default";
  if (priceVal === "low") tempProducts.sort((a, b) => a.price - b.price);
  else if (priceVal === "high") tempProducts.sort((a, b) => b.price - a.price);

  filteredProducts = tempProducts;
  renderProducts();
}

// ====== Event Listeners ======
searchBox?.addEventListener("input", debounce(applyFilters, 300));
categoryBox?.addEventListener("change", applyFilters);
priceBox?.addEventListener("change", applyFilters);

  /* ====== Init ====== */
  renderProducts();
  updateCartCount();
});
</script>
</body>
</html>
